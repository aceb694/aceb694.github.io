<!DOCTYPE html>
<html>
  <head>



    <meta charset="UTF-8">
    <title>Syrian Refugees in Iraq</title>
    <!-- The style.css file allows you to change the look of your web pages.
         If you include the next line in all your web pages, they will all share the same look.
         This makes it easier to make new pages for your site. -->

    <script src="./jquery-2.1.1.min.js"></script>


      <!--
    Load CartoDB's code so we can pull in our CartoDB maps.
    -->
    <script src="./cartodb-3.14.2.js"></script>
    <script src="./jquery-ui.1.10.3.js"></script>

    <!--Load jQRangeSlider-->
    <!--<script src="https://rawgit.com/aceb694/jQRangeSlider-5.7.1/master/jQRangeSlider-min.js"></script>-->
    <!--<script src="https://rawgit.com/aceb694/jQRangeSlider-5.7.1/master/jQAllRangeSliders-min.js"></script>-->
    <script src="./jQDateRangeSlider-withRuler-min.js"></script>




    <link rel="stylesheet" href="./css/cartodb.css" type="text/css"/>
    <link rel="stylesheet" href="./css/jquery-ui.css" type="text/css"/>

    <!--jQRangeSlider-->
    <link rel="stylesheet" href="./css/iThing.css" type="text/css" />

  <style>

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    width: 100%;
  }

  #map {
  display: inline-block;
  height: 100%;
  width: 100%;
}

    #title{
      text-align: center;
      font-size: 20px;
      font-family: "Arial";
      float: left;
      padding-left: 400px;
      padding-top: 25px;
      color: #74d94e;
    }

    #slider {
        position: absolute;
        bottom: 40px;
        right: 40px;
        left:40px;
      }

      #legend {
        font-family: serif;
        font-size: 27px;
        position: absolute;
        bottom: 80px;
        left: 40px;

    img {
      float:left;
    }

    h4{
      text-transform: uppercase;
    }

    #sulaymaniyah_anbar_erbil_duhok_ver3
    {
        polygon-fill: #253494;
    }

  </style>
  </head>
  <body>

<!--  /--------------------------------CREATE BODY DIVS------------------------------------------------------------/  -->


    <div id="map"></div>
    <div id="slider"></div>
    <div id="legend"></div>

<!--------------------------------END CREATE BODY DIVS------------------------------------------------------------      -->


<script>
/*--------------------------------START GENERATE SLIDER------------------------------------------------------------*/
        /*label array for date range slider*/
        var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];


        /*Add Date Range Slider with the following options*/
        $("#slider").dateRangeSlider(
        {
            defaultValues:
            {
                min: new Date(2013, 0),
                max: new Date(2013, 12, 1)
            },
            bounds:
            {
                min: new Date(2013, 0),
                max: new Date(2013, 12, 1)
            },
            step:
            {
                months: 1
            },
            /*The option scales requires an array of objects. Each object represents the configuration of one level.
            Scale configuration object can contain 5 functions:*/
            scales:
            [{
                //first: function(value){ return value; },
                //end: function(value) {return value; },
                next: function(value)
                {
                    var next = new Date(value);
                    return new Date(next.setMonth(value.getMonth() + 1));
                },
                label: function(value)
                {
                    return months[value.getMonth()];
                }/*,
                format: function(tickContainer, tickStart, tickEnd){
                  tickContainer.addClass("myCustomClass");
                }*/
            }]
        });
/*--------------------------------END GENERATE SLIDER------------------------------------------------------------ */







/*------------------------------START: DECLARE GLOBAL VARIABLES------------------------------------------------------------*/





         var As_Sulaymaniyah;
         var Al_Anbar;
         var Arbil;
         var Dihok;

         var RefugeePopulationLayer;





      //   var layerSource = {
      //   user_name: 'aceb694',
      //   type: 'cartodb',
      //   sublayers: [{
      //       sql: "SELECT * FROM sulaymaniyah_anbar_erbil_duhok_ver3", // African countries
      //       cartocss: '#sulaymaniyah_anbar_erbil_duhok_ver3{polygon-fill:#FF6600;polygon-opacity:0.7;line-color:#FFF;line-width:1;line-opacity:1;}'
      //   }]
      // }

         /*------------------------------END: DECLARE GLOBAL VARIABLES------------------------------------------------------------*/








/*------------------------------START: PULL DATA FROM DATABASE------------------------------------------------------------*/

    $(document).ready(function()
    {
        $.getJSON('https://aceb694.cartodb.com/api/v2/sql?q=SELECT%20monthly_pop_avg::integer%20AS%20monthly_pop_avg_int,%20month,%20year,%20governorate%20FROM%20sulaymaniyah_anbar_erbil_duhok_ver3%20WHERE%20year%20=%202013%20AND%20governorate%20=%20%27As-Sulaymaniyah%27%20ORDER%20BY%20month')
        .done(function (JSONarray)
        {
          As_Sulaymaniyah =  JSONarray;
        })

        $.getJSON('https://aceb694.cartodb.com/api/v2/sql?q=SELECT%20monthly_pop_avg::integer%20AS%20monthly_pop_avg_int,%20month,%20year,%20governorate%20FROM%20sulaymaniyah_anbar_erbil_duhok_ver3%20WHERE%20year%20=%202013%20AND%20governorate%20=%20%27Al-Anbar%27%20ORDER%20BY%20month')
        .done(function (JSONarray)
        {
          Al_Anbar =  JSONarray;
        })

        $.getJSON('https://aceb694.cartodb.com/api/v2/sql?q=SELECT%20monthly_pop_avg::integer%20AS%20monthly_pop_avg_int,%20month,%20year,%20governorate%20FROM%20sulaymaniyah_anbar_erbil_duhok_ver3%20WHERE%20year%20=%202013%20AND%20governorate%20=%20%27Arbil%27%20ORDER%20BY%20month')
        .done(function (JSONarray)
        {
          Arbil =  JSONarray;
        })

        $.getJSON('https://aceb694.cartodb.com/api/v2/sql?q=SELECT%20monthly_pop_avg::integer%20AS%20monthly_pop_avg_int,%20month,%20year,%20governorate%20FROM%20sulaymaniyah_anbar_erbil_duhok_ver3%20WHERE%20year%20=%202013%20AND%20governorate%20=%20%27Dihok%27%20ORDER%20BY%20month')
        .done(function (JSONarray)
        {
          Dihok =  JSONarray;
        })
    });
/*-------------------------------END: PULL DATA FROM DATABASE------------------------------------------------------------*/








/*-------------------------------START: LOAD CARTODB MAP------------------------------------------------------------*/

    $(document).ready(function ()
    {
        cartodb.createVis('map', 'https://aceb694.cartodb.com/api/v2/viz/dbe29aca-e6dc-11e4-b5d2-0e0c41326911/viz.json',
        {
            cartodb_logo: false,
            legends: true
        }).done(function(vis,layers)
        {
            // alert("Layers has " + layers.length + " layers.");

            RefugeePopulationLayer = layers[1].getSubLayer(0);

            // alert("Layers has " + layers[1].getSubLayerCount() + " sublayers.");




        })
    });

    //

/*-------------------------------END: LOAD CARTODB MAP------------------------------------------------------------*/









/*-------------------------------START: EVENT HANDLERS------------------------------------------------------------*/


    $("#slider").on("valuesChanging",

      function(e, sliderData)
      {
          console.log(As_Sulaymaniyah);
          console.log(Al_Anbar);
          console.log(Arbil);
          console.log(Dihok);


          var minMonth = sliderData.values.min.getMonth();  //retrieve the month the left most slider is on


          if(sliderData.values.max.getMonth() == 0)
              maxMonth = 11; /*because the slider value is 0 when it is selecting december, and it should be 11 because december data is in the array element 11*/
          else
              maxMonth =  sliderData.values.max.getMonth() - 1; //select the month the right most slider is on

          console.log('min value: ' + minMonth + ', max value: ' + maxMonth);
          //console.log(JSONfromCartoDB.rows[0].governorate);

          // var GovernorateDifference = new Array(4,3,5,'d');
            // var difference = {
            //   governorate: 'Al-Anbar',
            //   difference: Al_Anbar.rows[maxMonth].monthly_pop_avg_int - Al_Anbar.rows[minMonth].monthly_pop_avg_int
            // },
            // var difference = {
            //   governorate: 'As-Sulaymaniyah',
            //   difference: As_Sulaymaniyah.rows[maxMonth].monthly_pop_avg_int - As_Sulaymaniyah.rows[minMonth].monthly_pop_avg_int
            // },
            // var difference = {
            //   governorate: 'Arbil',
            //   difference: Arbil.rows[maxMonth].monthly_pop_avg_int - Arbil.rows[minMonth].monthly_pop_avg_int
            // });

          // var GovernorateDifference = {
          //     Al_Anbar_difference: Al_Anbar.rows[maxMonth].monthly_pop_avg_int - Al_Anbar.rows[minMonth].monthly_pop_avg_int,
          //     As_Sulaymaniyah_difference: As_Sulaymaniyah.rows[maxMonth].monthly_pop_avg_int - As_Sulaymaniyah.rows[minMonth].monthly_pop_avg_int,
          //     Arbil_difference: Arbil.rows[maxMonth].monthly_pop_avg_int - Arbil.rows[minMonth].monthly_pop_avg_int,
          //     Dihok_difference: Dihok.rows[maxMonth].monthly_pop_avg_int - Dihok.rows[minMonth].monthly_pop_avg_int};


          var AvgMonthlyRefugeePopDiff = [
            {
              governorate: "Al-Anbar",
              diffInMonths: Al_Anbar.rows[maxMonth].monthly_pop_avg_int - Al_Anbar.rows[minMonth].monthly_pop_avg_int,
            },
            {
              governorate: "As-Sulaymaniyah",
              diffInMonths: As_Sulaymaniyah.rows[maxMonth].monthly_pop_avg_int - As_Sulaymaniyah.rows[minMonth].monthly_pop_avg_int
            },
            {
              governorate: "Arbil",
              diffInMonths: Arbil.rows[maxMonth].monthly_pop_avg_int - Arbil.rows[minMonth].monthly_pop_avg_int
            },
            {
              governorate: "Dihok",
              diffInMonths: Dihok.rows[maxMonth].monthly_pop_avg_int - Dihok.rows[minMonth].monthly_pop_avg_int
            }];



            for(var i =0; i<4; i++)
            {
                if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= -3001)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#00aaff';
                else if (AvgMonthlyRefugeePopDiff[i].diffInMonths <= -2001)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#00bbff';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= -1001)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#00ccff';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= -1)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#00ddff';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths == 0)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#ffffff';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= 9999)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#6f0000';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= 24999)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#5c0000';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= 39999)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#490000';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= 54999)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#360000';
                else if(AvgMonthlyRefugeePopDiff[i].diffInMonths <= 62172)
                    AvgMonthlyRefugeePopDiff[i].hexColor = '#000000';
            }

          RefugeePopulationLayer.setCartoCSS("#sulaymaniyah_anbar_erbil_duhok_ver3 [governorate= '" + AvgMonthlyRefugeePopDiff[0].governorate + "']{ polygon-fill: " + AvgMonthlyRefugeePopDiff[0].hexColor + "; } [governorate='" + AvgMonthlyRefugeePopDiff[1].governorate + "'] { polygon-fill: " + AvgMonthlyRefugeePopDiff[1].hexColor + "; } [governorate= '" + AvgMonthlyRefugeePopDiff[2].governorate + "']{ polygon-fill: " + AvgMonthlyRefugeePopDiff[2].hexColor + ";} [governorate= '" + AvgMonthlyRefugeePopDiff[3].governorate + "']{ polygon-fill: " + AvgMonthlyRefugeePopDiff[3].hexColor + ";}"
          );

// -3000 to -2001 #00bbff
// -2000 to -1001 #00ccff
// -1000 to -1 #00ddff
// 0 #ffffff
// 1 to 9,999  #6f0000
// 10,000 to 24,999 #5c0000
// 25,000 to 39,999 #490000
// 40,000 to 54,999 #360000
// 55,000 to 62,172 #000000




          // if(Arbil_difference>=0)
          //   RefugeePopulationLayer.setCartoCSS("#sulaymaniyah_anbar_erbil_duhok_ver3 [governorate='Arbil']{ polygon-fill: #3E7BB6; }");
          // else
          //   RefugeePopulationLayer.setCartoCSS("#sulaymaniyah_anbar_erbil_duhok_ver3 [governorate='Arbil']{ polygon-fill: #870005; }");


            // set({'cartocss': '#layer {...}' })

            // alert("Sublayer CSS is " + RefugeePopulationLayer.getCartoCSS());
            // alert("Sublayer SQL is " + RefugeePopulationLayer.getSQL());



            // RefugeePopulationLayer.setCartoCSS("#sulaymaniyah_anbar_erbil_duhok_ver3 [governorate='As-Sulaymaniyah']{ polygon-fill: #3E7BB6; } [governorate='Arbil'] { polygon-fill: #870005; }");

      });

/*-------------------------------END: EVENT HANDLERS------------------------------------------------------------*/




    </script>


</body>
</html>
